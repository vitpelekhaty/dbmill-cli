# dbmill-cli

![test-dbmill-cli](https://github.com/vitpelekhaty/dbmill-cli/workflows/test-dbmill-cli/badge.svg?branch=master)

Утилита автоматизации некоторых задач обработки баз данных. Цель: разработать альтернативу утилите командной строки из поставки [dbForge Studio for SQL Server](https://www.devart.com/dbforge/sql/studio/), но с дополнительными возможностями.

## Поддерживаемые СУБД

**dbmill-cli** определяет тип СУБД, с которой предстоит работать, по схеме URL строки подключения к БД. 

### Microsoft SQL Server

Поддерживается SQL Server  с версиями от 13.х (SQL Server 2016). Для подключения к БД рекомендуется использовать следующие форматы строки подключения:

* sqlserver://username:password@host[:port]/[instance]?param1=value&param2=value

Например: sqlserver://sa:SuperseCReT@localhost?database=AdventureWorks2017

Windows-авторизация не поддерживается.

## Команды

### version

Показывает версию утилиты, время сборки и коммит, на основании которого была выполнена сборка.

### scriptsfolder

Создание файлов скриптов создания объектов БД в указанном каталоге. 

#### Флаги команды

| Флаг                |     Тип      | Описание                                                     |
| ------------------- | :----------: | ------------------------------------------------------------ |
| --path, -d          |    строка    | Путь к каталогу, в котором будут созданы скрипты. **Обязательный** |
| --db, -D            |    строка    | Строка подключения к базе данных. **Обязательный**           |
| --output-struct, -S |    строка    | Путь к файлу описания структуры каталога скриптов. Если не указан, то создается структура по умолчанию |
| --log, -l           |    строка    | Путь к файлу лога                                            |
| --log-level, -L     |    строка    | Уровень лога. Допустимые значения: trace, debug, info (по умолчанию), warning, error, fatal, panic |
| --filter-path, -F   |    строка    | Путь к файлу списка объектов БД, для которых будут созданы скрипты. Файл списка - обычный текстовый файл, каждая строка которого - это наименование объекта БД или регулярное выражение для имен объектов БД |
| --exclude-path, -E  |    строка    | Путь к файлу списка объектов БД, для которых скрипты создаваться **НЕ** будут. Структура файла аналогичная, как для *--filter-path* |
| --username, -U      |    строка    | Имя пользователя БД. Заменяет имя пользователя, указанное в строке соединения |
| --password, -P      |    строка    | Пароль пользователя БД. Заменяет пароль, указанный в строке соединения |
| --filter, -f        | массив строк | Наименования объектов БД, для которых будут созданы скрипты. Допускаются регулярные выражения. Значения флага заменяют список объектов БД, переданный флагом *--filter-path*. Если *--filter* и *--filter-path* не указаны, то создаются скрипты для всех поддерживаемых объектов БД |
| --exclude, -e       | массив строк | Наименования объектов БД, для которых скрипты создаваться **НЕ** будут. Допускаются регулярные выражения. Значения флага заменяют список объектов БД, переданный флагом *--exclude-path*. |
| --include-data      |  логическое  | Флаг необходимости создания скриптов заполнения таблиц       |
| --skip-permissions  |  логическое  | Не записывать в скрипты разрешения на объекты                |

#### Структура каталога скриптов

Чтобы выгружать скрипты в каталог с иной структурой подкаталогов, необходимо через параметр *--output-struct* передать путь к собственному файлу описания структуры c [yaml](https://yaml.org/) разметкой. 

Пример такого файла:

```yaml
## база данных
database:
  subdirectory: Database/
  mask: $object$.sql
## таблицы
table:
  subdirectory: Tables/
  mask: $schema$.$object$.sql
## данные таблиц
staticData:
  subdirectory: Tables/StaticData
  mask: $schema$.$object$.Data.sql
## представления
view:
  subdirectory: Views
  mask: $schema$.$object$.sql
## процедуры
procedure:
  subdirectory: Programmability/Procedures
  mask: $schema$.$object$.sql
## функции (скалярные и табличные)
function:
  subdirectory: Programmability/Functions
  mask: $schema$.$object$.sql
## DDL-триггеры
trigger:
  subdirectory: Programmability/Database/Triggers
  mask: $schema$.$object$.sql
## пользовательские типы данных
dataType:
  subdirectory: Programmability/User Types/Data Types
  mask: $schema$.$object$.sql
## пользовательские табличные типы
tableType:
  subdirectory: Programmability/User Types/Table Types
  mask: $schema$.$object$.sql
## схемы
schema:
  subdirectory: Security/Schemas
  mask: $schema$.sql
```

Для каждого указанного типа объектов указывается путь к соответствующему подкаталогу, а также маска имени файла. 

Маска может содержать элементы подстановки:

| Значение   | Описание                     |
| ---------- | ---------------------------- |
| $database$ | Псевдоним базы данных        |
| $schema$   | Наименование схемы           |
| $object$   | Наименование объекта БД      |
| $type$     | Наименование типа объекта БД |

Файл описания структуры может выступать фильтром типов объектов БД. Если в файле не указать какие-то типы объектов, то для таких объектов БД скрипты создаваться не будут.